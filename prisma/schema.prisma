generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  EDITOR
  SALES
  CLIENT
}

enum ProjectCategory {
  RESIDENTIAL
  VILLA
  COMMERCIAL
  OFFICE
  CAFE
  RESTAURANT
}

enum ServiceType {
  ARCHITECTURE
  INTERIOR
  RENOVATION
  DESIGN_BUILD
}

enum MediaType {
  IMAGE
  VIDEO
}

enum RequestType {
  ESTIMATE
  CONSULTATION
}

enum RequestStatus {
  NEW
  IN_REVIEW
  NEEDS_INFO
  ESTIMATE_SENT
  MEETING_SCHEDULED
  WON
  LOST
  ARCHIVED
}

enum RequestScope {
  DESIGN_ONLY
  DESIGN_BUILD
  RENOVATION
}

enum ContactMethod {
  PHONE
  WHATSAPP
  EMAIL
}

enum Currency {
  IRR
}

model User {
  id               String           @id @default(cuid())
  name             String
  email            String           @unique
  phone            String?
  passwordHash     String?
  role             Role             @default(CLIENT)
  emailVerified    DateTime?
  image            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  accounts         Account[]
  sessions         Session[]

  requestsAsClient Request[]        @relation("ClientRequests")
  requestsAssigned Request[]        @relation("AssignedRequests")
  requestMessages  RequestMessage[]
  requestNotes     RequestNote[]

  @@index([role])
}

model Project {
  id               String           @id @default(cuid())
  slug             String           @unique
  titleFa          String
  titleEn          String?
  category         ProjectCategory
  locationFa       String
  year             Int
  areaSqm          Int
  scopeFa          String
  servicesProvided ServiceType[]
  descriptionFa    String
  featured         Boolean          @default(false)
  published        Boolean          @default(false)
  coverImageUrl    String
  metaTitleFa      String?
  metaDescriptionFa String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  media            ProjectMedia[]

  @@index([published, featured])
  @@index([category, year])
}

model ProjectMedia {
  id        String    @id @default(cuid())
  projectId String
  type      MediaType @default(IMAGE)
  url       String
  order     Int       @default(0)
  altFa     String

  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, order])
}

model ContentBlock {
  id        String   @id @default(cuid())
  key       String   @unique
  contentFa Json
  contentEn Json?
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model Request {
  id                     String          @id @default(cuid())
  type                   RequestType
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  status                 RequestStatus   @default(NEW)

  clientId               String
  assignedToId           String?

  projectType            ProjectCategory
  locationCityFa         String
  addressFa              String
  mapPinLat              Float?
  mapPinLng              Float?
  areaSqm                Int?
  scope                  RequestScope
  budgetMin              Int?
  budgetMax              Int?
  budgetRangeText        String?
  timelineTarget         String?
  descriptionFa          String
  preferredContactMethod ContactMethod
  meetingStartAt         DateTime?
  meetingEndAt           DateTime?
  meetingReminderSentAt  DateTime?
  sourceProjectId        String?

  client                 User            @relation("ClientRequests", fields: [clientId], references: [id], onDelete: Cascade)
  assignedTo             User?           @relation("AssignedRequests", fields: [assignedToId], references: [id], onDelete: SetNull)
  files                  RequestFile[]
  messages               RequestMessage[]
  notes                  RequestNote[]
  estimate               Estimate?
  availabilitySlot       AvailabilitySlot?

  @@index([clientId, createdAt])
  @@index([assignedToId, status])
  @@index([status, type, createdAt])
}

model RequestFile {
  id         String   @id @default(cuid())
  requestId  String
  objectKey  String   @map("url")
  fileName   String
  fileType   String
  sizeBytes  Int      @default(0)
  uploadedAt DateTime @default(now())

  request    Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
}

model RequestMessage {
  id         String   @id @default(cuid())
  requestId  String
  authorId   String
  message    String
  createdAt  DateTime @default(now())

  request    Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([requestId, createdAt])
}

model RequestNote {
  id         String   @id @default(cuid())
  requestId  String
  authorId   String
  note       String
  createdAt  DateTime @default(now())

  request    Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([requestId, createdAt])
}

model Estimate {
  id               String   @id @default(cuid())
  requestId         String   @unique
  costAmount        Decimal  @db.Decimal(14, 2)
  currency          Currency @default(IRR)
  timeEstimateText  String
  nextStepsFa       String
  sentAt            DateTime @default(now())

  request           Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
}

model AvailabilitySlot {
  id              String   @id @default(cuid())
  startAt         DateTime
  endAt           DateTime
  isBooked        Boolean  @default(false)
  bookedRequestId String?  @unique
  createdAt       DateTime @default(now())

  bookedRequest   Request? @relation(fields: [bookedRequestId], references: [id], onDelete: SetNull)

  @@index([startAt, endAt, isBooked])
}

model ContactMessage {
  id         String   @id @default(cuid())
  name       String
  phone      String
  email      String?
  message    String
  createdAt  DateTime @default(now())
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
